<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meeting Minutes</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF (stable CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- jsPDF AutoTable plugin -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    @media print {
      body { background: #fff !important; }
      .no-print { display: none !important; }
      .card { box-shadow: none !important; border: 1px solid #e5e7eb; }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

  <div class="card bg-white rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-4xl mx-auto border-t-8 border-blue-500">
    <header class="text-center mb-8 flex flex-col items-center">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">Electricity Market Operations Unit</h1>
      <p class="mt-2 text-gray-600">Meeting Notes</p>
    </header>

    <section class="space-y-6">
      <div class="grid sm:grid-cols-2 gap-6">
        <div>
          <label for="meeting-title" class="block text-sm font-medium text-gray-700 mb-1">Meeting Title</label>
          <input id="meeting-title" type="text" placeholder="Project Alpha Kick-off" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="meeting-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
          <input id="meeting-date" type="date" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
      </div>

      <div class="grid sm:grid-cols-2 gap-6">
        <div>
          <label for="venue" class="block text-sm font-medium text-gray-700 mb-1">Venue</label>
          <input id="venue" type="text" placeholder="Conference Room 2B" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="attendees" class="block text-sm font-medium text-gray-700 mb-1">Attendees (comma separated)</label>
          <input id="attendees" type="text" placeholder="John, Jane, Sarah" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
      </div>

      <div>
        <label for="agenda-discussion" class="block text-sm font-medium text-gray-700 mb-1">Agenda & Discussion</label>
        <textarea id="agenda-discussion" rows="10" placeholder="1) Item One&#10;- Discussion point A&#10;- Decision...&#10;2) Item Two&#10;- Notes..." class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        <p class="text-xs text-gray-500 mt-1">Tip: bullet points are fineâ€”long text will wrap across PDF pages.</p>
      </div>

      <div>
        <label for="action-items" class="block text-sm font-medium text-gray-700 mb-1">Action Items (one per line)</label>
        <textarea id="action-items" rows="8" placeholder="- Prepare draft MoM | Jane | 2025-09-22 | In progress&#10;- Confirm venue | Helmi | 2025-09-21 | Done" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        <p class="text-xs text-gray-500 mt-1">Format: <code>- Task | Owner | Due Date | Status</code>.</p>
      </div>
    </section>

    <div class="no-print mt-8 flex flex-col sm:flex-row justify-end items-center gap-4">
      <button id="save-pdf" class="w-full sm:w-auto px-6 py-3 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
        Save as PDF
      </button>
      <button id="send-email" class="w-full sm:w-auto px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
        Send via Email
      </button>
      <button id="send-whatsapp" class="w-full sm:w-auto px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
        Send to WhatsApp
      </button>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-gray-600/50 items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-sm text-center">
      <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
      <p id="modal-msg" class="text-gray-700 mb-6"></p>
      <button id="modal-close" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Close</button>
    </div>
  </div>

  <script>
    // Tiny helpers
    const $ = (id) => document.getElementById(id);
    function showModal(title, msg) {
      $('modal-title').innerText = title;
      $('modal-msg').innerText = msg;
      $('modal').classList.remove('hidden');
      $('modal').classList.add('flex');
    }
    $('modal-close').addEventListener('click', () => {
      $('modal').classList.add('hidden');
      $('modal').classList.remove('flex');
    });

    // Default date
    window.addEventListener('DOMContentLoaded', () => {
      const d = new Date();
      const iso = d.toISOString().slice(0,10);
      if (!$('meeting-date').value) $('meeting-date').value = iso;
    });

    function niceDate(iso) {
      if (!iso) return 'Not specified';
      const d = new Date(iso);
      return isNaN(d) ? iso : d.toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
    }

    function getNoteContent() {
      const title = $('meeting-title').value || 'Untitled Meeting';
      const date = $('meeting-date').value;
      const attendees = $('attendees').value || 'Not specified';
      const venue = $('venue').value || 'Not specified';
      const agendaDiscussion = $('agenda-discussion').value || 'No agenda or discussion provided.';
      const actionItems = $('action-items').value || 'No action items.';

      return `Meeting Minutes: ${title}

Date: ${niceDate(date)}
Venue: ${venue}
Attendees: ${attendees}

Agenda & Discussion:
${agendaDiscussion}

Action Items:
${actionItems}`;
    }

    function parseActionItems(raw) {
      const rows = [];
      const lines = (raw || '').split('\n').map(l => l.trim()).filter(Boolean);
      for (const line of lines) {
        const clean = line.replace(/^\-\s*/, '');
        const parts = clean.split('|').map(p => p.trim());
        const [task, owner, due, status] = [parts[0] || clean, parts[1] || '', parts[2] || '', parts[3] || ''];
        rows.push([task, owner, due, status]);
      }
      return rows;
    }

    // SAVE PDF
    $('save-pdf').addEventListener('click', () => {
      try {
        // Library guards
        if (!window.jspdf || !window.jspdf.jsPDF) {
          showModal('PDF Error', 'jsPDF did not load. Check your internet connection or CDN.');
          return;
        }
        if (typeof jsPDF === 'undefined' && window.jspdf) {
          // make jsPDF global if needed
          window.jsPDF = window.jspdf.jsPDF;
        }
        if (typeof jsPDF === 'undefined') {
          showModal('PDF Error', 'jsPDF is unavailable.');
          return;
        }
        if (typeof window.jspdf === 'object' && typeof window.jspdf.jsPDF === 'function' && typeof jsPDF !== 'function') {
          window.jsPDF = window.jspdf.jsPDF;
        }
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });

        const margin = 40;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        const title = $('meeting-title').value || 'Untitled Meeting';
        const dateIso = $('meeting-date').value;
        const venue = $('venue').value || 'Not specified';
        const attendees = $('attendees').value || 'Not specified';
        const agendaText = $('agenda-discussion').value || 'No agenda or discussion provided.';
        const actionText = $('action-items').value || '';

        const runAt = new Date().toLocaleString('en-US');
        const headerTitle = 'Electricity Market Operations Unit';
        const headerSubtitle = 'Meeting Notes';

        function drawHeaderFooter(data) {
          doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
          doc.text(headerTitle, margin, 30);
          doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
          doc.text(headerSubtitle, margin, 46);
          doc.setFont('helvetica', 'normal'); doc.setFontSize(9);
          const generated = `Generated: ${runAt}`;
          const w = doc.getTextWidth(generated);
          doc.text(generated, pageWidth - margin - w, 30);
          doc.setDrawColor(200); doc.line(margin, 56, pageWidth - margin, 56);
          const str = `Page ${data.pageNumber}`;
          const fw = doc.getTextWidth(str);
          doc.setFontSize(9); doc.text(str, pageWidth - margin - fw, pageHeight - 20);
        }

        const baseOpts = {
          margin: { top: 72, left: margin, right: margin, bottom: 40 },
          styles: { font: 'helvetica', fontSize: 10, cellPadding: 6, overflow: 'linebreak' },
          headStyles: { fillColor: [37, 99, 235], textColor: 255, fontStyle: 'bold' },
          didDrawPage: drawHeaderFooter
        };

        // Title
        let y = 84;
        doc.setFont('helvetica', 'bold'); doc.setFontSize(14);
        doc.text(title, margin, y); y += 18;

        // Summary (requires autotable)
        if (typeof doc.autoTable !== 'function') {
          showModal('PDF Error', 'AutoTable plugin did not load. Check the jsDelivr link.');
          return;
        }

        const summary = [
          ['Date', niceDate(dateIso)],
          ['Venue', venue],
          ['Attendees', attendees]
        ];
        doc.autoTable({
          ...baseOpts,
          startY: y,
          theme: 'plain',
          styles: { ...baseOpts.styles, cellPadding: { top: 4, right: 8, bottom: 4, left: 0 } },
          columnStyles: { 0: { cellWidth: 80, fontStyle: 'bold' }, 1: { cellWidth: pageWidth - margin * 2 - 80 } },
          body: summary
        });
        y = doc.lastAutoTable.finalY + 16;

        // Agenda
        doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
        doc.text('Agenda & Discussion', margin, y); y += 8;

        const agendaLines = doc.splitTextToSize(agendaText, pageWidth - margin * 2);
        doc.autoTable({
          ...baseOpts,
          startY: y,
          theme: 'plain',
          styles: { ...baseOpts.styles, cellPadding: { top: 6, right: 8, bottom: 6, left: 8 } },
          columnStyles: { 0: { cellWidth: pageWidth - margin * 2 } },
          body: agendaLines.map(line => [line])
        });
        y = doc.lastAutoTable.finalY + 16;

        // Action items
        doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
        doc.text('Action Items', margin, y); y += 8;

        const aiRows = parseActionItems(actionText);
        const bodyRows = aiRows.length ? aiRows : [['No action items recorded', '', '', '']];

        doc.autoTable({
          ...baseOpts,
          startY: y,
          head: [['Task', 'Owner', 'Due Date', 'Status']],
          body: bodyRows,
          columnStyles: {
            0: { cellWidth: pageWidth - margin * 2 - 200 },
            1: { cellWidth: 80 },
            2: { cellWidth: 70 },
            3: { cellWidth: 50 }
          }
        });

        const safeTitle = (title || 'Untitled Meeting').replace(/[^\w\-]+/g, '_').replace(/_+/g, '_').slice(0, 80);
        const fileDate = (dateIso || '').replace(/-/g, '') || new Date().toISOString().slice(0,10).replace(/-/g, '');
        doc.save(`${fileDate}_${safeTitle}_Minutes.pdf`);

        showModal('Saved', 'Your meeting minutes were saved as a PDF.');
      } catch (err) {
        console.error(err);
        showModal('Unexpected Error', String(err && err.message ? err.message : err));
      }
    });

    // Email
    $('send-email').addEventListener('click', () => {
      const subject = encodeURIComponent('Meeting Minutes');
      const body = encodeURIComponent(getNoteContent());
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
      showModal('Email Drafted', 'Your email client should open with the meeting minutes. Please send it manually.');
    });

    // WhatsApp
    $('send-whatsapp').addEventListener('click', () => {
      const text = encodeURIComponent(getNoteContent());
      window.open(`https://wa.me/?text=${text}`, '_blank');
      showModal('WhatsApp Drafted', 'A new window or tab has opened. Pick a contact and send your message.');
    });
  </script>
</body>
</html>
