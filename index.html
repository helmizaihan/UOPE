<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meeting Minutes</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-NAp3x1n0Gd8mC9u8r3n8qf8m6Yl1gXo4i9mQ6YcT6a8qZ9b0k3F4g0O3p9m7O8vZ4qQyZ4x8H9Q1r1m3Q2QJ0Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js" integrity="sha512-5p8R0v2s6Qzj0m4c7n0nLqz0Jqkz8wQbN6m0xv8tM3m9o9mJr7oXb0q6e7XfFjz2Hk0vXrM1rYk9l0C1pJmR0w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    /* Better print look if the page itself is printed */
    @media print {
      body { background: #fff !important; }
      .no-print { display: none !important; }
      .card { box-shadow: none !important; border: 1px solid #e5e7eb; }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

  <div class="card bg-white rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-4xl mx-auto border-t-8 border-blue-500">
    <header class="text-center mb-8 flex flex-col items-center">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">Electricity Market Operations Unit</h1>
      <p class="mt-2 text-gray-600">Meeting Notes</p>
    </header>

    <section class="space-y-6">
      <!-- Meeting Details -->
      <div class="grid sm:grid-cols-2 gap-6">
        <div>
          <label for="meeting-title" class="block text-sm font-medium text-gray-700 mb-1">Meeting Title</label>
          <input id="meeting-title" type="text" placeholder="Project Alpha Kick-off" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="meeting-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
          <input id="meeting-date" type="date" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
      </div>

      <div class="grid sm:grid-cols-2 gap-6">
        <div>
          <label for="venue" class="block text-sm font-medium text-gray-700 mb-1">Venue</label>
          <input id="venue" type="text" placeholder="Conference Room 2B" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="attendees" class="block text-sm font-medium text-gray-700 mb-1">Attendees (comma separated)</label>
          <input id="attendees" type="text" placeholder="John, Jane, Sarah" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
      </div>

      <div>
        <label for="agenda-discussion" class="block text-sm font-medium text-gray-700 mb-1">Agenda & Discussion</label>
        <textarea id="agenda-discussion" rows="10" placeholder="1) Item One&#10;- Discussion point A&#10;- Decision...&#10;2) Item Two&#10;- Notes..." class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        <p class="text-xs text-gray-500 mt-1">Tip: bullet points are fineâ€”long text will wrap across PDF pages.</p>
      </div>

      <div>
        <label for="action-items" class="block text-sm font-medium text-gray-700 mb-1">Action Items (one per line)</label>
        <textarea id="action-items" rows="8" placeholder="- Prepare draft MoM | Jane | 2025-09-22 | In progress&#10;- Confirm venue | Helmi | 2025-09-21 | Done" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        <p class="text-xs text-gray-500 mt-1">Format: <code>- Task | Owner | Due Date | Status</code>. Fields after Task are optional.</p>
      </div>
    </section>

    <!-- Buttons -->
    <div class="no-print mt-8 flex flex-col sm:flex-row justify-end items-center gap-4">
      <button id="save-pdf" class="w-full sm:w-auto px-6 py-3 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
        Save as PDF
      </button>
      <button id="send-email" class="w-full sm:w-auto px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
        Send via Email
      </button>
      <button id="send-whatsapp" class="w-full sm:w-auto px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
        Send to WhatsApp
      </button>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-gray-600/50 items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-sm text-center">
      <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
      <p id="modal-msg" class="text-gray-700 mb-6"></p>
      <button id="modal-close" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Close</button>
    </div>
  </div>

  <script>
    // Default date = today
    window.addEventListener('DOMContentLoaded', () => {
      const d = new Date();
      const iso = d.toISOString().slice(0,10);
      const dateEl = document.getElementById('meeting-date');
      if (!dateEl.value) dateEl.value = iso;
    });

    // Helpers
    const $ = (id) => document.getElementById(id);

    function showModal(title, msg) {
      $('modal-title').innerText = title;
      $('modal-msg').innerText = msg;
      $('modal').classList.remove('hidden');
      $('modal').classList.add('flex');
    }
    $('modal-close').addEventListener('click', () => {
      $('modal').classList.add('hidden');
      $('modal').classList.remove('flex');
    });

    function niceDate(iso) {
      if (!iso) return 'Not specified';
      const d = new Date(iso);
      if (isNaN(d)) return iso;
      return d.toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
    }

    function getNoteContent() {
      const title = $('meeting-title').value || 'Untitled Meeting';
      const date = $('meeting-date').value;
      const attendees = $('attendees').value || 'Not specified';
      const venue = $('venue').value || 'Not specified';
      const agendaDiscussion = $('agenda-discussion').value || 'No agenda or discussion provided.';
      const actionItems = $('action-items').value || 'No action items.';

      return `Meeting Minutes: ${title}

Date: ${niceDate(date)}
Venue: ${venue}
Attendees: ${attendees}

Agenda & Discussion:
${agendaDiscussion}

Action Items:
${actionItems}`;
    }

    // Parse action items from lines into rows for AutoTable
    function parseActionItems(raw) {
      const rows = [];
      const lines = (raw || '').split('\n').map(l => l.trim()).filter(Boolean);
      for (const line of lines) {
        // Expected: "- Task | Owner | Due Date | Status"
        const clean = line.replace(/^\-\s*/, '');
        const parts = clean.split('|').map(p => p.trim());
        const [task, owner, due, status] = [
          parts[0] || clean,
          parts[1] || '',
          parts[2] || '',
          parts[3] || ''
        ];
        rows.push([task, owner, due, status]);
      }
      return rows;
    }

    // PDF generation with professional header/footer and tables
    $('save-pdf').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' }); // A4, 72pt = 1 inch
      const margin = 40;
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();

      const title = $('meeting-title').value || 'Untitled Meeting';
      const dateIso = $('meeting-date').value;
      const venue = $('venue').value || 'Not specified';
      const attendees = $('attendees').value || 'Not specified';
      const agendaText = $('agenda-discussion').value || 'No agenda or discussion provided.';
      const actionText = $('action-items').value || '';

      const runAt = new Date().toLocaleString('en-US');
      const headerTitle = 'Electricity Market Operations Unit';
      const headerSubtitle = 'Meeting Notes';

      // Shared header/footer
      function drawHeaderFooter(data) {
        // Header
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(12);
        doc.text(headerTitle, margin, 30);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        doc.text(headerSubtitle, margin, 46);

        // Right side date
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        const generated = `Generated: ${runAt}`;
        const w = doc.getTextWidth(generated);
        doc.text(generated, pageWidth - margin - w, 30);

        // Divider
        doc.setDrawColor(200);
        doc.line(margin, 56, pageWidth - margin, 56);

        // Footer
        const str = `Page ${data.pageNumber}`;
        doc.setFontSize(9);
        const fw = doc.getTextWidth(str);
        doc.text(str, pageWidth - margin - fw, pageHeight - 20);
      }

      // Use AutoTable's hook to draw header/footer on every page
      const autoTableOpts = {
        margin: { top: 72, left: margin, right: margin, bottom: 40 },
        styles: { font: 'helvetica', fontSize: 10, cellPadding: 6, overflow: 'linebreak' },
        headStyles: { fillColor: [37, 99, 235], textColor: 255, fontStyle: 'bold' },
        didDrawPage: drawHeaderFooter
      };

      // MEETING SUMMARY BLOCK
      let y = 72 + 12; // after header
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(14);
      doc.text(title, margin, y);
      y += 18;

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(11);
      const summary = [
        ['Date', niceDate(dateIso)],
        ['Venue', venue],
        ['Attendees', attendees]
      ];

      // Render summary as two-column key/value table
      doc.autoTable({
        ...autoTableOpts,
        startY: y,
        theme: 'plain',
        styles: { ...autoTableOpts.styles, cellPadding: { top: 4, right: 8, bottom: 4, left: 0 } },
        columnStyles: {
          0: { cellWidth: 80, fontStyle: 'bold' },
          1: { cellWidth: pageWidth - margin * 2 - 80 }
        },
        body: summary
      });
      y = doc.lastAutoTable.finalY + 16;

      // AGENDA & DISCUSSION
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text('Agenda & Discussion', margin, y);
      y += 8;

      const agendaLines = doc.splitTextToSize(agendaText, pageWidth - margin * 2);
      doc.autoTable({
        ...autoTableOpts,
        startY: y,
        theme: 'plain',
        styles: { ...autoTableOpts.styles, cellPadding: { top: 6, right: 8, bottom: 6, left: 8 } },
        columnStyles: { 0: { cellWidth: pageWidth - margin * 2 } },
        body: agendaLines.map(line => [line])
      });
      y = doc.lastAutoTable.finalY + 16;

      // ACTION ITEMS TABLE
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text('Action Items', margin, y);
      y += 8;

      const aiRows = parseActionItems(actionText);
      const bodyRows = aiRows.length ? aiRows : [['No action items recorded', '', '', '']];

      doc.autoTable({
        ...autoTableOpts,
        startY: y,
        head: [['Task', 'Owner', 'Due Date', 'Status']],
        body: bodyRows,
        columnStyles: {
          0: { cellWidth: pageWidth - margin * 2 - 200 }, // Task gets more space
          1: { cellWidth: 80 },
          2: { cellWidth: 70 },
          3: { cellWidth: 50 }
        }
      });

      // File name
      const safeTitle = (title || 'Untitled Meeting')
        .replace(/[^\w\-]+/g, '_')
        .replace(/_+/g, '_')
        .slice(0, 80);
      const fileDate = (dateIso || '').replace(/-/g, '') || new Date().toISOString().slice(0,10).replace(/-/g, '');
      doc.save(`${fileDate}_${safeTitle}_Minutes.pdf`);

      showModal('Saved', 'Your meeting minutes have been saved as a PDF with improved formatting.');
    });

    // Email
    $('send-email').addEventListener('click', () => {
      const subject = encodeURIComponent('Meeting Minutes');
      const body = encodeURIComponent(getNoteContent());
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
      showModal('Email Drafted', 'Your email client should open with the meeting minutes. Please send it manually.');
    });

    // WhatsApp
    $('send-whatsapp').addEventListener('click', () => {
      const text = encodeURIComponent(getNoteContent());
      window.open(`https://wa.me/?text=${text}`, '_blank');
      showModal('WhatsApp Drafted', 'A new window or tab has opened. Pick a contact and send your message.');
    });
  </script>
</body>
</html>
